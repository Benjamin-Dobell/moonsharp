name: UPM Release

on:
  push:
    tags:
      - "v*"
      - "beta/v*"

jobs:
  publish-upm-branches:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse tag and resolve target metadata
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          TAG_SHA="${GITHUB_SHA}"

          if [[ "${TAG}" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            PACKAGE_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            BRANCH_PREFIX="upm"
            RELEASE_NAME="${VERSION}"
            RELEASE_PRERELEASE="false"
          elif [[ "${TAG}" =~ ^beta/v([0-9]+)\.([0-9]+)\.([0-9]+)-([0-9]+)$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            BETA_NUMBER="${BASH_REMATCH[4]}"
            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            PACKAGE_VERSION="${MAJOR}.${MINOR}.${PATCH}-beta.${BETA_NUMBER}"
            BRANCH_PREFIX="upm/beta"
            RELEASE_NAME="${VERSION} Beta #${BETA_NUMBER}"
            RELEASE_PRERELEASE="true"
          elif [[ "${TAG}" =~ ^beta/v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            PACKAGE_VERSION="${MAJOR}.${MINOR}.${PATCH}-beta"
            BRANCH_PREFIX="upm/beta"
            RELEASE_NAME="${VERSION} Beta"
            RELEASE_PRERELEASE="true"
          else
            echo "Unsupported tag format: ${TAG}"
            echo "Expected: vX.X.X or beta/vX.X.X or beta/vX.X.X-Y"
            exit 1
          fi

          echo "TAG=${TAG}" >> "${GITHUB_ENV}"
          echo "TAG_SHA=${TAG_SHA}" >> "${GITHUB_ENV}"
          echo "MAJOR=${MAJOR}" >> "${GITHUB_ENV}"
          echo "MINOR=${MINOR}" >> "${GITHUB_ENV}"
          echo "VERSION=${VERSION}" >> "${GITHUB_ENV}"
          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> "${GITHUB_ENV}"
          echo "BRANCH_PREFIX=${BRANCH_PREFIX}" >> "${GITHUB_ENV}"
          echo "RELEASE_NAME=${RELEASE_NAME}" >> "${GITHUB_ENV}"
          echo "RELEASE_PRERELEASE=${RELEASE_PRERELEASE}" >> "${GITHUB_ENV}"

      - name: Download CI UPM artifact for tag commit
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          CORE_ARTIFACT_NAME="unity-package-tgz"
          DEBUG_ARTIFACT_NAME="unity-package-vscode-debugger-tgz"
          VSIX_ARTIFACT_NAME="vscode-dap-vsix"
          CLI_LINUX_ARTIFACT_NAME="moonsharp-cli-sc-linux-x64"
          CLI_OSX_ARTIFACT_NAME="moonsharp-cli-sc-osx-arm64"
          CLI_WIN_ARTIFACT_NAME="moonsharp-cli-sc-win-x64"
          CORE_ARTIFACT_ID=""
          DEBUG_ARTIFACT_ID=""
          VSIX_ARTIFACT_ID=""
          CLI_LINUX_ARTIFACT_ID=""
          CLI_OSX_ARTIFACT_ID=""
          CLI_WIN_ARTIFACT_ID=""
          RUN_ID=""

          while IFS= read -r CANDIDATE_RUN_ID; do
            [ -z "${CANDIDATE_RUN_ID}" ] && continue
            [[ "${CANDIDATE_RUN_ID}" =~ ^[0-9]+$ ]] || continue
            CANDIDATE_CORE_ARTIFACT_ID="$(gh api "/repos/${GITHUB_REPOSITORY}/actions/runs/${CANDIDATE_RUN_ID}/artifacts" \
              --jq ".artifacts[] | select(.name == \"${CORE_ARTIFACT_NAME}\" and .expired == false) | .id" | head -n1 || true)"
            CANDIDATE_DEBUG_ARTIFACT_ID="$(gh api "/repos/${GITHUB_REPOSITORY}/actions/runs/${CANDIDATE_RUN_ID}/artifacts" \
              --jq ".artifacts[] | select(.name == \"${DEBUG_ARTIFACT_NAME}\" and .expired == false) | .id" | head -n1 || true)"
            CANDIDATE_VSIX_ARTIFACT_ID="$(gh api "/repos/${GITHUB_REPOSITORY}/actions/runs/${CANDIDATE_RUN_ID}/artifacts" \
              --jq ".artifacts[] | select(.name == \"${VSIX_ARTIFACT_NAME}\" and .expired == false) | .id" | head -n1 || true)"
            CANDIDATE_CLI_LINUX_ARTIFACT_ID="$(gh api "/repos/${GITHUB_REPOSITORY}/actions/runs/${CANDIDATE_RUN_ID}/artifacts" \
              --jq ".artifacts[] | select(.name == \"${CLI_LINUX_ARTIFACT_NAME}\" and .expired == false) | .id" | head -n1 || true)"
            CANDIDATE_CLI_OSX_ARTIFACT_ID="$(gh api "/repos/${GITHUB_REPOSITORY}/actions/runs/${CANDIDATE_RUN_ID}/artifacts" \
              --jq ".artifacts[] | select(.name == \"${CLI_OSX_ARTIFACT_NAME}\" and .expired == false) | .id" | head -n1 || true)"
            CANDIDATE_CLI_WIN_ARTIFACT_ID="$(gh api "/repos/${GITHUB_REPOSITORY}/actions/runs/${CANDIDATE_RUN_ID}/artifacts" \
              --jq ".artifacts[] | select(.name == \"${CLI_WIN_ARTIFACT_NAME}\" and .expired == false) | .id" | head -n1 || true)"

            if [ -n "${CANDIDATE_CORE_ARTIFACT_ID}" ] && [ -n "${CANDIDATE_DEBUG_ARTIFACT_ID}" ] && [ -n "${CANDIDATE_VSIX_ARTIFACT_ID}" ] && [ -n "${CANDIDATE_CLI_LINUX_ARTIFACT_ID}" ] && [ -n "${CANDIDATE_CLI_OSX_ARTIFACT_ID}" ] && [ -n "${CANDIDATE_CLI_WIN_ARTIFACT_ID}" ]; then
              RUN_ID="${CANDIDATE_RUN_ID}"
              CORE_ARTIFACT_ID="${CANDIDATE_CORE_ARTIFACT_ID}"
              DEBUG_ARTIFACT_ID="${CANDIDATE_DEBUG_ARTIFACT_ID}"
              VSIX_ARTIFACT_ID="${CANDIDATE_VSIX_ARTIFACT_ID}"
              CLI_LINUX_ARTIFACT_ID="${CANDIDATE_CLI_LINUX_ARTIFACT_ID}"
              CLI_OSX_ARTIFACT_ID="${CANDIDATE_CLI_OSX_ARTIFACT_ID}"
              CLI_WIN_ARTIFACT_ID="${CANDIDATE_CLI_WIN_ARTIFACT_ID}"
              break
            fi
          done < <(gh run list \
            --workflow ci.yml \
            --json databaseId,headSha,conclusion \
            --limit 200 \
            --jq ".[] | select(.headSha == \"${TAG_SHA}\" and .conclusion == \"success\") | .databaseId")

          if [ -z "${RUN_ID}" ] || [ -z "${CORE_ARTIFACT_ID}" ] || [ -z "${DEBUG_ARTIFACT_ID}" ] || [ -z "${VSIX_ARTIFACT_ID}" ] || [ -z "${CLI_LINUX_ARTIFACT_ID}" ] || [ -z "${CLI_OSX_ARTIFACT_ID}" ] || [ -z "${CLI_WIN_ARTIFACT_ID}" ]; then
            echo "No successful workflow run with required release artifacts found for commit ${TAG_SHA}."
            exit 1
          fi

          ARTIFACT_TMP="/tmp/upm-artifact"
          rm -rf "${ARTIFACT_TMP}"
          mkdir -p "${ARTIFACT_TMP}"

          download_artifact_tgz() {
            local artifact_id="$1"
            local out_dir="$2"
            mkdir -p "${out_dir}"
            gh api "/repos/${GITHUB_REPOSITORY}/actions/artifacts/${artifact_id}/zip" > "${out_dir}/artifact.zip"
            unzip -q -j "${out_dir}/artifact.zip" -d "${out_dir}" >/dev/null
            find "${out_dir}" -maxdepth 1 -name '*.tgz' | head -n1
          }

          download_artifact_vsix() {
            local artifact_id="$1"
            local out_dir="$2"
            mkdir -p "${out_dir}"
            gh api "/repos/${GITHUB_REPOSITORY}/actions/artifacts/${artifact_id}/zip" > "${out_dir}/artifact.zip"
            unzip -q -j "${out_dir}/artifact.zip" -d "${out_dir}" >/dev/null
            find "${out_dir}" -maxdepth 1 -name '*.vsix' | head -n1
          }

          download_artifact_cli_file() {
            local artifact_id="$1"
            local out_dir="$2"
            local pattern="$3"
            mkdir -p "${out_dir}"
            gh api "/repos/${GITHUB_REPOSITORY}/actions/artifacts/${artifact_id}/zip" > "${out_dir}/artifact.zip"
            unzip -q -j "${out_dir}/artifact.zip" -d "${out_dir}" >/dev/null
            find "${out_dir}" -maxdepth 1 -name "${pattern}" | head -n1
          }

          repack_with_release_version() {
            local in_tarball="$1"
            local out_tarball="$2"
            local repack_dir="$3"
            rm -rf "${repack_dir}"
            mkdir -p "${repack_dir}"
            tar -xzf "${in_tarball}" -C "${repack_dir}"
            local package_json="${repack_dir}/package/package.json"
            if [ ! -f "${package_json}" ]; then
              echo "Invalid package tarball: package/package.json not found."
              exit 1
            fi
            sed -E "s/\"version\"[[:space:]]*:[[:space:]]*\"[^\"]+\"/\"version\": \"${PACKAGE_VERSION}\"/" \
              "${package_json}" > "${package_json}.tmp"
            mv "${package_json}.tmp" "${package_json}"
            (
              cd "${repack_dir}"
              tar -czf "${out_tarball}" package
            )
          }

          CORE_TARBALL="$(download_artifact_tgz "${CORE_ARTIFACT_ID}" "${ARTIFACT_TMP}/core")"
          DEBUG_TARBALL="$(download_artifact_tgz "${DEBUG_ARTIFACT_ID}" "${ARTIFACT_TMP}/debug")"
          VSIX_FILE="$(download_artifact_vsix "${VSIX_ARTIFACT_ID}" "${ARTIFACT_TMP}/vsix")"
          MOONSHARP_CLI_LINUX_FILE="$(download_artifact_cli_file "${CLI_LINUX_ARTIFACT_ID}" "${ARTIFACT_TMP}/moonsharp-cli-linux" '*.tar.gz')"
          MOONSHARP_CLI_OSX_FILE="$(download_artifact_cli_file "${CLI_OSX_ARTIFACT_ID}" "${ARTIFACT_TMP}/moonsharp-cli-osx" '*.tar.gz')"
          MOONSHARP_CLI_WIN_FILE="$(download_artifact_cli_file "${CLI_WIN_ARTIFACT_ID}" "${ARTIFACT_TMP}/moonsharp-cli-win" '*.zip')"

          if [ -z "${CORE_TARBALL}" ] || [ -z "${DEBUG_TARBALL}" ] || [ -z "${VSIX_FILE}" ] || [ -z "${MOONSHARP_CLI_LINUX_FILE}" ] || [ -z "${MOONSHARP_CLI_OSX_FILE}" ] || [ -z "${MOONSHARP_CLI_WIN_FILE}" ]; then
            echo "Downloaded artifacts do not contain expected .tgz/.vsix/.tar.gz/.zip packages."
            exit 1
          fi

          CORE_REPACK_TARBALL="${ARTIFACT_TMP}/org.moonsharp.moonsharp-${PACKAGE_VERSION}.tgz"
          DEBUG_REPACK_TARBALL="${ARTIFACT_TMP}/org.moonsharp.debugger.vscode-${PACKAGE_VERSION}.tgz"

          repack_with_release_version "${CORE_TARBALL}" "${CORE_REPACK_TARBALL}" "${ARTIFACT_TMP}/core-repack"
          repack_with_release_version "${DEBUG_TARBALL}" "${DEBUG_REPACK_TARBALL}" "${ARTIFACT_TMP}/debug-repack"

          echo "CORE_TARBALL_PATH=${CORE_REPACK_TARBALL}" >> "${GITHUB_ENV}"
          echo "DEBUG_TARBALL_PATH=${DEBUG_REPACK_TARBALL}" >> "${GITHUB_ENV}"
          echo "VSCODE_VSIX_PATH=${VSIX_FILE}" >> "${GITHUB_ENV}"
          echo "MOONSHARP_CLI_LINUX_PATH=${MOONSHARP_CLI_LINUX_FILE}" >> "${GITHUB_ENV}"
          echo "MOONSHARP_CLI_OSX_PATH=${MOONSHARP_CLI_OSX_FILE}" >> "${GITHUB_ENV}"
          echo "MOONSHARP_CLI_WIN_PATH=${MOONSHARP_CLI_WIN_FILE}" >> "${GITHUB_ENV}"

      - name: Publish package to version branches
        run: |
          set -euo pipefail

          CORE_TMP_DIR="$(mktemp -d)"
          DEBUG_TMP_DIR="$(mktemp -d)"
          tar -xzf "${CORE_TARBALL_PATH}" -C "${CORE_TMP_DIR}"
          tar -xzf "${DEBUG_TARBALL_PATH}" -C "${DEBUG_TMP_DIR}"

          CORE_PACKAGE_DIR="${CORE_TMP_DIR}/package"
          DEBUG_PACKAGE_DIR="${DEBUG_TMP_DIR}/package"

          if [ ! -f "${CORE_PACKAGE_DIR}/package.json" ]; then
            echo "Invalid core tarball: package.json missing in package/."
            exit 1
          fi

          if [ ! -f "${DEBUG_PACKAGE_DIR}/package.json" ]; then
            echo "Invalid debugger tarball: package.json missing in package/."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin

          publish_branch() {
            local branch="$1"

            if git ls-remote --exit-code --heads origin "${branch}" >/dev/null 2>&1; then
              git checkout -B "${branch}" "origin/${branch}"
            else
              git checkout --orphan "${branch}"
            fi

            git rm -rf --ignore-unmatch . || true
            git clean -fdx

            mkdir -p interpreter
            mkdir -p debugger/vscode

            rsync -a "${CORE_PACKAGE_DIR}/" interpreter/
            rsync -a "${DEBUG_PACKAGE_DIR}/" debugger/vscode/
            git add -A

            if git diff --cached --quiet; then
              echo "No changes for ${branch}; skipping commit."
            else
              git commit -m "UPM ${TAG}"
              git push origin "${branch}"
            fi
          }

          publish_branch "${BRANCH_PREFIX}/v${MAJOR}"
          publish_branch "${BRANCH_PREFIX}/v${MAJOR}.${MINOR}"

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if gh release view "${TAG}" >/dev/null 2>&1; then
            RELEASE_ID="$(gh release view "${TAG}" --json databaseId --jq '.databaseId')"
            gh api -X PATCH "repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID}" \
              -f name="${RELEASE_NAME}" \
              -F prerelease="${RELEASE_PRERELEASE}" >/dev/null
            gh release upload "${TAG}" "${CORE_TARBALL_PATH}" "${DEBUG_TARBALL_PATH}" "${VSCODE_VSIX_PATH}" "${MOONSHARP_CLI_LINUX_PATH}" "${MOONSHARP_CLI_OSX_PATH}" "${MOONSHARP_CLI_WIN_PATH}" --clobber
          else
            if [ "${RELEASE_PRERELEASE}" = "true" ]; then
              gh release create "${TAG}" "${CORE_TARBALL_PATH}" "${DEBUG_TARBALL_PATH}" "${VSCODE_VSIX_PATH}" "${MOONSHARP_CLI_LINUX_PATH}" "${MOONSHARP_CLI_OSX_PATH}" "${MOONSHARP_CLI_WIN_PATH}" \
                --target "${TAG_SHA}" \
                --title "${RELEASE_NAME}" \
                --notes "Automated UPM release for ${TAG}." \
                --prerelease
            else
              gh release create "${TAG}" "${CORE_TARBALL_PATH}" "${DEBUG_TARBALL_PATH}" "${VSCODE_VSIX_PATH}" "${MOONSHARP_CLI_LINUX_PATH}" "${MOONSHARP_CLI_OSX_PATH}" "${MOONSHARP_CLI_WIN_PATH}" \
                --target "${TAG_SHA}" \
                --title "${RELEASE_NAME}" \
                --notes "Automated UPM release for ${TAG}."
            fi
          fi
