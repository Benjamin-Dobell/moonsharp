name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  docker-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build CI image
        run: docker build --platform linux/amd64 -t moonsharp-ci .

      - name: Run CI
        run: docker run --rm --platform linux/amd64 moonsharp-ci

  upm-artifact:
    runs-on: ubuntu-latest
    needs: docker-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Stage UPM package
        run: tools/upm/stage-local-package.sh 0.0.0-ci.${{ github.run_number }}

      - name: Pack UPM tarball
        run: |
          cd .upm-staging/org.moonsharp.moonsharp
          npm pack

      - name: Pack VSCode debugger UPM tarball
        run: |
          cd .upm-staging/org.moonsharp.debugger.vscode
          npm pack

      - name: Upload UPM tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-package-tgz
          path: .upm-staging/org.moonsharp.moonsharp/*.tgz

      - name: Upload VSCode debugger UPM tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-package-vscode-debugger-tgz
          path: .upm-staging/org.moonsharp.debugger.vscode/*.tgz

      - name: Install VSCode extension dependencies
        run: |
          cd src/moonsharp-vscode-debug
          npm install

      - name: Compile VSCode extension
        run: |
          cd src/moonsharp-vscode-debug
          npm run compile

      - name: Build VSCode extension VSIX
        run: |
          cd src/moonsharp-vscode-debug
          npm run package:vsix

      - name: Upload VSCode extension VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-dap-vsix
          path: src/moonsharp-vscode-debug/*.vsix

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build MoonSharp CLI (net8.0)
        run: dotnet build src/MoonSharp/MoonSharp.csproj -c Release -f net8.0 -v minimal

      - name: Build DotNetCoreTestRunner (net8.0)
        run: dotnet build src/TestRunners/DotNetCoreTestRunner/DotNetCoreTestRunner.csproj -c Release -f net8.0 -v minimal

      - name: Smoke test MoonSharp CLI from stdin
        run: |
          set -euo pipefail
          cat src/MoonSharp/ci-smoke.lua | dotnet run --project src/MoonSharp/MoonSharp.csproj -c Release -f net8.0 > moonsharp-cli-smoke.log
          grep -q "24" moonsharp-cli-smoke.log

      - name: Hardwire codegen smoke (dump -> -W)
        run: |
          set -euo pipefail
          mkdir -p .artifacts/hardwire
          dotnet run --project src/TestRunners/DotNetCoreTestRunner/DotNetCoreTestRunner.csproj -c Release -- /dump-types .artifacts/hardwire/testdump.lua
          dotnet run --project src/MoonSharp/MoonSharp.csproj -c Release -f net8.0 -- -W .artifacts/hardwire/testdump.lua .artifacts/hardwire/HardwiredTypesSmoke.cs
          test -s .artifacts/hardwire/testdump.lua
          test -s .artifacts/hardwire/HardwiredTypesSmoke.cs
          grep -q "StringBuilder" .artifacts/hardwire/testdump.lua
          grep -q "StringBuilder" .artifacts/hardwire/HardwiredTypesSmoke.cs

      - name: Publish MoonSharp CLI (self-contained linux-x64)
        run: |
          set -euo pipefail
          mkdir -p .artifacts/moonsharp-cli/linux-x64
          dotnet publish src/MoonSharp/MoonSharp.csproj -c Release -f net8.0 -r linux-x64 --self-contained true -o .artifacts/moonsharp-cli/linux-x64 -v minimal
          tar -czf .artifacts/moonsharp-cli/moonsharp-cli-sc-linux-x64.tar.gz -C .artifacts/moonsharp-cli/linux-x64 .

      - name: Upload MoonSharp CLI self-contained linux-x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: moonsharp-cli-sc-linux-x64
          path: .artifacts/moonsharp-cli/moonsharp-cli-sc-linux-x64.tar.gz

      - name: Publish MoonSharp CLI (self-contained osx-arm64)
        run: |
          set -euo pipefail
          mkdir -p .artifacts/moonsharp-cli/osx-arm64
          dotnet publish src/MoonSharp/MoonSharp.csproj -c Release -f net8.0 -r osx-arm64 --self-contained true -o .artifacts/moonsharp-cli/osx-arm64 -v minimal
          tar -czf .artifacts/moonsharp-cli/moonsharp-cli-sc-osx-arm64.tar.gz -C .artifacts/moonsharp-cli/osx-arm64 .

      - name: Upload MoonSharp CLI self-contained osx-arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: moonsharp-cli-sc-osx-arm64
          path: .artifacts/moonsharp-cli/moonsharp-cli-sc-osx-arm64.tar.gz

      - name: Publish MoonSharp CLI (self-contained win-x64)
        run: |
          set -euo pipefail
          mkdir -p .artifacts/moonsharp-cli/win-x64
          dotnet publish src/MoonSharp/MoonSharp.csproj -c Release -f net8.0 -r win-x64 --self-contained true -o .artifacts/moonsharp-cli/win-x64 -v minimal
          (
            cd .artifacts/moonsharp-cli/win-x64
            zip -qr ../moonsharp-cli-sc-win-x64.zip .
          )

      - name: Upload MoonSharp CLI self-contained win-x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: moonsharp-cli-sc-win-x64
          path: .artifacts/moonsharp-cli/moonsharp-cli-sc-win-x64.zip

  unity-testbed-headless:
    runs-on: ubuntu-latest
    needs: docker-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build Unity test dependencies (net45)
        run: |
          cd src
          dotnet build MoonSharp.Interpreter.Tests/MoonSharp.Interpreter.Tests.csproj -c Release -f net45 -v minimal

      - name: Sync UnityTestBed plugins
        run: |
          cd src
          ./Unity/ResynchAssets.sh

      - name: Run UnityTestBed scene in batchmode (GameCI)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: src/Unity/UnityTestBed
          unityVersion: 2019.4.41f2
          targetPlatform: StandaloneLinux64
          buildMethod: MoonSharp.UnityTestBed.BatchRunner.Run
          allowDirtyBuild: true
          customParameters: -batchmode -nographics -logFile -

  devtools-build:
    runs-on: ubuntu-latest
    needs: docker-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Mono runtime
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-runtime

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build DevTools Playground
        run: dotnet build src/DevTools/Playground/Playground.csproj -c Release -v minimal

      - name: Run DevTools Playground
        run: mono bin/Release/net45/Playground.exe
        working-directory: src/DevTools/Playground

      - name: Build DevTools PerformanceComparison
        run: dotnet build src/DevTools/PerformanceComparison/PerformanceComparison.csproj -c Release -v minimal

      - name: Run DevTools PerformanceComparison (MoonSharp vs NLua)
        run: dotnet run --project src/DevTools/PerformanceComparison/PerformanceComparison.csproj -c Release

      - name: Build DevTools VsCodeDebugger_Testbed
        run: dotnet build src/DevTools/VsCodeDebugger_Testbed/VsCodeDebugger_Testbed.csproj -c Release -v minimal
